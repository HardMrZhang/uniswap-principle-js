# uniswap-principle-js
unsiwap自动做市原理代码解释


### 什么是uniswap

1. uniswap是一种自动流动性协议(官网解释),基于以太坊的去中心化交换协议.没有订单或者任何一方集中要求交易.无需向交易所那样要求用户放弃对私钥的控制权,得先存入一定额的资产.不用担心交易所卷款跑路,更加安全可靠。
2. .v1是eth与erc20代币的交换,v2加入了两种erc20代币直接交换。
3. 特别的是uniswap的每种代币定价方式,他并没有处采用传统的订单簿方式,价格有由最高买家和最低买家决定.uniswap采用自动做市商方式,根据资产的供求关系决定资产的定价,

### unsiwap的工作流程

1. 创建流动性池:任何人都可以在uniswap添加代币与代币或者eth与代币交换的池子。添加数量由第一个创建者决定。第一个提供流动性的人存入的币种的比例决定了这两种币种的兑换的初始价格。比如eth-ionc,存入1个eth和10个ionc,那么1个eth可以兑换10个ionc
2. 添加流动性:池子创建好了,用户可以不断的向这个流动性池子里存入这两种代币,这个不断存入的过程就是添加流动性.提供流动性后,uniwap会分配给你LP token,LP token代表你提供流动性的比例,然后把LP token抵押到uniswap里，unsiwap会根据这个比例给你分配UNI币,然后用户可以把UNI卖掉变成现金,这就是流动性挖矿。
3. 代币授权(approve)：交换之前要授权router合约,可以代替用户去转账代币。
4. 交换代币:接下来你可以在uniwap上交换两种代币了,价格决定我会在下面介绍。兑换的时候回收取0.3%的手续费,这个手续费会奖励给提供流动性的人。

```js
流动池就是锁定在智能合约中所有的代币以及资金的总称，流动是资金转为代币，或代币转为资金的意思。
```

###Uniwap自动化做市商原理

1. uniswap采用恒定乘积做市商模型：x*y=k,通过某一时刻(一般是创建流动性池的时候)确定x,y的兑换比例,来实现x,y的自动交易,所有的交易规则都在智能合约中规定好了.

2. x-y-k模型

   ```
   x,y为某个交易对(pair/pool)在某一时间在池中两种代币的余额
   ```

   - 无手续费的情况

     1. 所以*∆x*在x的区间内,*∆y*在y的区间内,设
        $$
        α = ∆x/x \\ 
        β = ∆y/y
        $$
        当*∆x*和*∆y*进行交换时,代币量更新为
        $$
        x′ = x+∆x = (1+α)x \\
        y′ = y-∆y = (1-β)y
        $$

        因为恒定乘积的原则,所以
        $$
        ∵ x′*y′ = x*y  \\
        ∴ (1 +α)*x * (1-β)*y = x*y \\
        ∴ （1+α)(1-β) = 1  \\
        	得 1+α = 1/(1-β)
        $$

      2. 由下面的公式推断出,变化前的xy和变化后的x′y′是相等的
         $$
         ∆x = β/(1-β) *x \\
         ∆y = α/(1+α) *y \\
         ======> \\
         x′ = x+∆x = (1+α)x  =  1/(1-β)* x\\
         y′ = y-∆y = 1 /(1+α)*y = (1-β) * y
         $$

   - 有手续费的情况

     1. 现在每笔交易都要把手续费考虑进去,设手续费 ρ∈[0,1),则
        $$
        x′ = x+∆x = (1+α(1-ρ))*x \\
        y′ = y-∆y = (1-β)*y
        $$
        *∆x*在x的区间内,*∆y*在y的区间内,并且xy=x′y′,则
        $$
        (1+α(1-ρ))*x *(1-β)*y = xy \\
        ===> \\
        1+α(1-ρ) = 1/(1-β)
        $$
        化简得
        $$
        △x = (β/(1-β)) * (1/(1-ρ)) *x \\
        △y = α(1-ρ)/(1+α(1-ρ)) *y
        $$
        再假设 1-ρ = γ,则
        $$
        △x = (β/(1-β)) * 1/γ *x \\
        △y = αγ/(1+αγ) *y
        $$
        如果γ为1时,就是手续费ρ=0时,就是上面无手续的情况,加入手续费后,则
        $$
        x′ = x+∆x = (1+α)x  =  (1+β((1/γ)-1))/(1-β) * x\\
        y′ = y-∆y = 1/(1+αγ)*y = (1-β) * y
        $$
        那么k = x′*y′为
        $$
        1+β((1/γ)-1) * xy = k
        $$
        会发现k是变大的,这是因为一部分的x作为手续费,没有参与恒定乘积的计算,而放到了流动性池子里。

3. 交易价格的计算有两种方法,一种给定x的数量,计算能兑换的y的数量,另一种给定y的数量,反推需要x的数量

   - 给定x推算y的数量

     - 如果要卖出△x,用来兑换获得的△y为
       $$
       △y = αγ/(1+αγ) *y
       $$
       ,交换后池子中的x′,y′为
       $$
       x′= x+△x = (1+αx)*x  \\
       y′= y-△y = 1/(1+αγ) *y
       $$
       y的价格为△x/△y
       $$
       \frac {△x}{△y} = \frac {αx}{\frac {αγ}{1+αγ}*y} = \frac {1+αγ}{γ} * \frac xy 
       $$
       由此可以看出,α越大,对y的价格影响越大,当α取1时,刚好2个x可以换1个y,这种情况对价格的影响最大打,所以在uniswap前端执行swap时会先检查用户输入对价格是否有很大影响。

   - 给定y反推x的数量

     - 如果要卖出△y,所需要的△x为
       $$
       △x  = \frac {β}{1-β}* \frac{1}{γ} *x
       $$

       ```
       注意:这里依然是用x来兑换y,不是用y来兑换x,只是先给出已知△y的数量,推算出需要的△x
       ```

       当β为0.5的时候,x,y是等价的,交换过池子中的x′,y′为
       $$
       x′= x+△x = \frac {1+β (\frac {1}{γ}-1)}{1-β} *x  \\ 
       y′ = y-△y = (1-β)y
       $$
       这时y的价格为
       $$
       \frac {△x}{△y} = \frac {1}{(1-β)*γ} * \frac{x}{y}
       $$
       可见β越大,y的价格越高,就是说卖出的y越多,池子里的y就会变少,x变多,y的价格自然变高。